
{% extends 'base.html' %}  <!--K·∫ø th·ª´a-->
{% block title %}{{ book.name }}- ADCbook{% endblock %} <!--VD:To√°n l·ªõp 5 - ADCbook-->
{% block content %} <!--B·∫Øt ƒë·∫ßu n·ªôi dung-->
<div class="mb-4">
    <a href="{% url 'home' %}" class="btn btn-ghost btn-sm">‚Üê Quay l·∫°i trang ch·ªß</a>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-8"> <!--Desktop: 2 c·ªôt; Mobile: 1 c·ªôt-->
    <div>
        {% if book.image %}
        <!--book.image.url l·∫•y t·ª´ model Book-->
        <img src="{{ book.image.url }}" alt="{{ book.name }}" class="w-full rounded-lg shadow-xl"> {% else %} 
        <div class="bg-base-200 w-full h-96 flex items-center justify-center rounded-lg">
            <span class="text-9xl">üìñ</span>
        </div>
        {% endif %}
    </div>

    <div>
        <h1 class="text-4xl font-bold mb-4">{{ book.name }}</h1> <!--T√™n s√°ch-->
        <!--Kh√≥a ngo·∫°i-->
        <p class="text-lg mb-2">{{ book.subject.name }} - {{ book.grade.name }}</p> <!--M√¥n h·ªçc - Kh·ªëi-->

        <div class="flex items-center gap-2 mb-4">
            <!--Hi·ªÉn th·ªã sao ƒë√°nh gi√°-->
            <div class="rating rating-md">
                {% with avg=book.average_rating %} {% for i in "12345" %} 
                <input type="radio" class="mask mask-star-2 bg-orange-400" 
                disabled {% if forloop.counter <= avg %}checked{% endif %}> {% endfor %} {% endwith %}
            </div>
            <span class="text-lg">({{ book.ratings.count }} ratings)</span>
        </div>
        <!-- Hi·ªÉn th·ªã gi√° s√°ch -->
        <p class="text-3xl font-bold text-primary mb-6">{{ book.price }} VNƒê</p>

        <!-- M√¥ t·∫£ s√°ch -->
        {% if book.description %} <!--tr√°nh hi·ªÉn th·ªã n·∫øu tr·ªëng-->
        <div class="mb-6">
            <h3 class="text-xl font-bold mb-2">M√¥ t·∫£</h3>
            <p class="text-gray-700">{{ book.description }}</p>
        </div>

        {% endif %} 
        <!-- Th√™m v√†o gi·ªè h√†ng -->
        {% if user.is_authenticated %} <!--Ch·ªâ cho user ƒëƒÉng nh·∫≠p m·ªõi ƒë∆∞·ª£c mua-->
        <form method="post" action="{% url 'add_to_cart' book.pk %}" class="flex gap-4 mb-6"> <!--g·ª≠i d·ªØ li·ªáu t·ªõi be; book.pk=ID s√°ch-->
            {% csrf_token %} <!--B·∫£o m·∫≠t Django, Ch·ªëng t·∫•n c√¥ng CSRF-->
            <input type="number" name="quantity" value="1" min="1" class="input input-bordered w-24"> <!--Ng∆∞·ªùi d√πng ch·ªçn s·ªë l∆∞·ª£ng-->
            <button type="submit" class="btn btn-primary">Th√™m v√†o gi·ªè h√†ng</button>
        </form>
        {% else %}
        <!--khi ch∆∞a ƒëƒÉng nh·∫≠p-->
        <p class="text-gray-500 mb-6">L√†m ∆°n <a href="{% url 'login' %}" class="link">ƒëƒÉng nh·∫≠p</a> ƒë·ªÉ th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng</p>
        {% endif %}
    </div>
</div>

{% if user.is_authenticated %} <!--Ki·ªÉm tra ƒë√£ ƒëƒÉng nh·∫≠p hay ch∆∞a, n·∫øu ch∆∞a th√¨ tr·∫£ v·ªÅ False-->
<div class="divider my-8"></div> <!--Ch·ªâ user ƒëƒÉng nh·∫≠p m·ªõi th·∫•y-->

<div class="mb-8">
    <h2 class="text-2xl font-bold mb-4">ƒê√°nh gi√° c·ªßa b·∫°n</h2>
    <form method="post" action="{% url 'add_rating' book.pk %}" class="flex gap-4 items-center">
        {% csrf_token %} <!--B·∫£o m·∫≠t Django, Ch·ªëng t·∫•n c√¥ng CSRF-->
        <div class="rating rating-lg">
            {% for i in "12345" %} <!--d√πng ƒë·ªÉ: L·∫∑p 5 l·∫ßn ƒë·ªÉ v·∫Ω 5 sao-->
            <input type="radio" name="rating" value="{{ forloop.counter }}" class="mask mask-star-2 bg-orange-400" 
            {% if user_rating and user_rating.rating == forloop.counter %}checked{% endif %}> {% endfor %}
        </div>
        <button type="submit" class="btn btn-primary">G·ª≠i ƒë√°nh gi√°</button>
    </form>
</div>

<div class="mb-8">
    <h2 class="text-2xl font-bold mb-4">Th√™m b√¨nh lu·∫≠n</h2>
    <form method="post" action="{% url 'add_comment' book.pk %}">
        {% csrf_token %} <!--B·∫£o m·∫≠t Django, Ch·ªëng t·∫•n c√¥ng CSRF-->
        <textarea name="text" class="textarea textarea-bordered w-full" placeholder="H√£y vi·∫øt b√¨nh lu·∫≠n c·ªßa b·∫°n..." rows="4" required></textarea>
        <button type="submit" class="btn btn-primary mt-2">ƒêƒÉng b√¨nh lu·∫≠n</button>
    </form>
</div>
{% endif %}

<!-- Hi·ªÉn th·ªã b√¨nh lu·∫≠n -->
<div>
    <h2 class="text-2xl font-bold mb-4">B√¨nh lu·∫≠n ({{ comments.count }})</h2>
    {% for comment in comments %} <!--comments ƒë∆∞·ª£c truy·ªÅn t·ª´ view-->
    <div class="card bg-base-100 shadow-md mb-4">
        <div class="card-body">
            <div class="flex justify-between items-start">
                <div>
                    <h3 class="font-bold">{{ comment.user.username }}</h3> <!--T√™n ng∆∞·ªùi b√¨nh lu·∫≠n-->
                    <p class="text-sm text-gray-500">{{ comment.created_at|date:"F d, Y" }}</p> <!--Ng√†y-->
                </div>
                {% if comment.user == user %} <!--ƒê√°nh d·∫•u comment c·ªßa ch√≠nh m√¨nh-->
                <span class="badge badge-primary">B√¨nh lu·∫≠n c·ªßa b·∫°n</span> {% endif %}
            </div>
            <p class="mt-2 break-all">{{ comment.text }}</p> <!--N·ªôi dung b√¨nh lu·∫≠n-->
        </div>
    </div>
    {% empty %}
    <p class="text-gray-500">Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o. H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n b√¨nh lu·∫≠n!</p>
    {% endfor %}
</div>
{% endblock %}